<script src="scripts/toggle.js"></script>
<script>
(function () {
  const STORAGE_KEY = "numberingMode"; // "legal" | "arabic"
  const DEFAULT_MODE = "legal";

  // Create UI
  function makeButton(label, value) {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "numbering-btn";
    btn.dataset.mode = value;
    btn.textContent = label;
    btn.addEventListener("click", () => setMode(value, true));
    return btn;
  }

  function setActive(container, mode) {
    container.querySelectorAll(".numbering-btn").forEach(b => {
      b.classList.toggle("active", b.dataset.mode === mode);
      b.setAttribute("aria-pressed", b.dataset.mode === mode ? "true" : "false");
    });
  }

  function setMode(mode, persist) {
    try {
      if (window.setNumberingMode) {
        window.setNumberingMode(mode);
      }
      document.documentElement.classList.remove("legal", "arabic");
      document.documentElement.classList.add(mode);
      if (persist) localStorage.setItem(STORAGE_KEY, mode);
      if (container) setActive(container, mode);
    } catch(e) {
      // no-op on error
    }
  }

  function findSidebarTools() {
    // Try common Quarto selectors; fall back to sidebar header
    return (
      document.querySelector(".sidebar-tools-main") ||
      document.querySelector(".sidebar-tools") ||
      document.querySelector(".sidebar-header") ||
      document.querySelector(".sidebar")
    );
  }

  // Build container
  const container = document.createElement("div");
  container.className = "numbering-toggle";
  container.setAttribute("role", "group");
  container.setAttribute("aria-label", "Numbering mode");

  const legalBtn = makeButton("Legal", "legal");
  const arabicBtn = makeButton("Arabic", "arabic");
  container.appendChild(legalBtn);
  container.appendChild(arabicBtn);

  // Insert in sidebar tools area once DOM is ready
  function initUI() {
    const host = findSidebarTools();
    if (!host) return false;

    // Place it inline with other tools
    host.appendChild(container);

    // Restore last mode or default
    const saved = localStorage.getItem(STORAGE_KEY) || DEFAULT_MODE;
    setActive(container, saved);

    // Ensure mode applied after your toggle.js initialized
    // Try immediately, then once after a tick
    setMode(saved, false);
    setTimeout(() => setMode(saved, false), 0);

    // Keyboard shortcut: Alt+N to toggle
    document.addEventListener("keydown", (e) => {
      if (e.altKey && (e.key === "n" || e.key === "N")) {
        const current = localStorage.getItem(STORAGE_KEY) || DEFAULT_MODE;
        const next = current === "legal" ? "arabic" : "legal";
        setMode(next, true);
      }
    });

    return true;
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => { initUI(); });
  } else {
    if (!initUI()) {
      // Retry once if sidebar mounts late
      setTimeout(initUI, 100);
    }
  }
})();
</script>
